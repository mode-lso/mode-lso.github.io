<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Integration Plan - Mode Collection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: linear-gradient(135deg, #1A6FDF 0%, #0d47a1 100%);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        h2 {
            font-size: 1.8rem;
            margin: 30px 0 15px;
            color: #1A6FDF;
            border-bottom: 2px solid #1A6FDF;
            padding-bottom: 8px;
        }
        
        h3 {
            font-size: 1.4rem;
            margin: 20px 0 10px;
            color: #0d47a1;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #e3f2fd;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .card h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h3 i {
            color: #1A6FDF;
        }
        
        .step {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .diagram {
            text-align: center;
            margin: 25px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .diagram img {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .caption {
            font-style: italic;
            color: #666;
            margin-top: 10px;
        }
        
        ul, ol {
            padding-left: 20px;
            margin: 15px 0;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .payment-flow {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 25px 0;
        }
        
        .flow-step {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .step-number {
            background: #1A6FDF;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: bold;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header>
        <h1>Payment Integration Plan</h1>
        <p class="subtitle">M-Pesa & EcoCash Implementation for Mode Collection</p>
    </header>
    
    <div class="alert">
        <i class="fas fa-exclamation-circle"></i> This plan assumes you're using a third-party payment aggregator like Flutterwave, DusuPay, or similar.
    </div>
    
    <div class="container">
        <div class="card">
            <h3><i class="fas fa-list-check"></i> Implementation Steps</h3>
            
            <div class="step">
                <h4>1. Choose Payment Aggregator</h4>
                <p>Select a provider that supports both M-Pesa and EcoCash:</p>
                <ul>
                    <li>Flutterwave</li>
                    <li>DusuPay</li>
                    <li>Peach Payments</li>
                    <li>Onfon Mobile</li>
                </ul>
            </div>
            
            <div class="step">
                <h4>2. Create Merchant Account</h4>
                <p>Register with your chosen provider and complete their verification process. You'll need:</p>
                <ul>
                    <li>Business registration documents</li>
                    <li>Bank account details</li>
                    <li>Business address verification</li>
                </ul>
            </div>
            
            <div class="step">
                <h4>3. Integrate Payment Gateway</h4>
                <p>Add the payment SDK to your website. Most providers offer:</p>
                <ul>
                    <li>JavaScript widgets</li>
                    <li>Mobile SDKs</li>
                    <li>API documentation</li>
                </ul>
            </div>
            
            <div class="step">
                <h4>4. Modify Product Pages</h4>
                <p>Update your product templates to include payment options:</p>
                <div class="code-block">
&lt;div class="payment-options"&gt;
    &lt;button onclick="initiatePayment('mpesa')"&gt;
        &lt;img src="mpesa-logo.png" alt="M-Pesa"&gt;
    &lt;/button&gt;
    &lt;button onclick="initiatePayment('ecocash')"&gt;
        &lt;img src="ecocash-logo.png" alt="EcoCash"&gt;
    &lt;/button&gt;
&lt;/div&gt;
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3><i class="fas fa-code"></i> Technical Implementation</h3>
            
            <div class="step">
                <h4>Payment Initialization</h4>
                <p>Add this JavaScript function to handle payments:</p>
                <div class="code-block">
function initiatePayment(provider, productId, amount) {
    // Get affiliate ID from URL or localStorage
    const affiliateId = getAffiliateId();
    
    // Create payment request
    const paymentData = {
        provider: provider,
        productId: productId,
        amount: amount,
        affiliateId: affiliateId,
        customerPhone: prompt("Enter your phone number:")
    };
    
    // Send to your backend
    fetch('/api/initiate-payment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(paymentData)
    })
    .then(response => response.json())
    .then(data => {
        if(data.success) {
            // Redirect to payment gateway or show instructions
            showPaymentInstructions(data);
        } else {
            alert('Payment initiation failed: ' + data.message);
        }
    });
}
                </div>
            </div>
            
            <div class="step">
                <h4>Backend API Endpoint</h4>
                <p>Create a server endpoint to handle payment requests:</p>
                <div class="code-block">
// Example using Node.js/Express
app.post('/api/initiate-payment', async (req, res) => {
    try {
        const { provider, productId, amount, affiliateId, customerPhone } = req.body;
        
        // Create payment with aggregator API
        const paymentResult = await paymentAggregator.initiatePayment({
            provider,
            amount,
            phone: customerPhone,
            reference: `ORDER-${Date.now()}-${productId}`
        });
        
        // Save to database with 'pending' status
        await savePaymentToDB({
            reference: paymentResult.reference,
            productId,
            amount,
            affiliateId,
            status: 'pending'
        });
        
        res.json({ 
            success: true, 
            instructions: paymentResult.instructions,
            reference: paymentResult.reference
        });
    } catch (error) {
        res.json({ success: false, message: error.message });
    }
});
                </div>
            </div>
            
            <div class="step">
                <h4>Payment Webhook Handler</h4>
                <p>Set up a webhook to receive payment confirmations:</p>
                <div class="code-block">
app.post('/api/payment-webhook', async (req, res) => {
    const { reference, status, amount } = req.body;
    
    // Verify the webhook signature (important for security)
    if (!verifySignature(req)) {
        return res.status(400).send('Invalid signature');
    }
    
    // Update payment status in database
    await updatePaymentStatus(reference, status);
    
    // If payment successful, notify affiliate
    if (status === 'successful') {
        const payment = await getPaymentFromDB(reference);
        if (payment.affiliateId) {
            notifyAffiliate(payment.affiliateId, payment.amount);
        }
        
        // Send order confirmation to customer
        sendOrderConfirmation(payment);
    }
    
    res.status(200).send('Webhook processed');
});
                </div>
            </div>
        </div>
    </div>
    
    <h2>Payment Flow Process</h2>
    <div class="payment-flow">
        <div class="flow-step">
            <div class="step-number">1</div>
            <div>
                <strong>Customer selects payment method</strong>
                <p>Customer chooses either M-Pesa or EcoCash on product page</p>
            </div>
        </div>
        
        <div class="flow-step">
            <div class="step-number">2</div>
            <div>
                <strong>Payment initiated</strong>
                <p>System sends request to payment aggregator with order details</p>
            </div>
        </div>
        
        <div class="flow-step">
            <div class="step-number">3</div>
            <div>
                <strong>Customer completes payment</strong>
                <p>Customer receives prompt on phone to authorize payment</p>
            </div>
        </div>
        
        <div class="flow-step">
            <div class="step-number">4</div>
            <div>
                <strong>Payment confirmation</strong>
                <p>Aggregator sends webhook to your server with payment status</p>
            </div>
        </div>
        
        <div class="flow-step">
            <div class="step-number">5</div>
            <div>
                <strong>Order processing</strong>
                <p>System updates order status and notifies affiliate if applicable</p>
            </div>
        </div>
        
        <div class="flow-step">
            <div class="step-number">6</div>
            <div>
                <strong>Customer confirmation</strong>
                <p>Customer receives order confirmation via WhatsApp/SMS</p>
            </div>
        </div>
    </div>
    
    <h2>Affiliate Tracking Integration</h2>
    <div class="card">
        <p>Your existing affiliate tracking system needs these enhancements:</p>
        
        <div class="step">
            <h4>1. Track Completed Payments</h4>
            <p>Only credit affiliates when payments are successfully completed, not when orders are placed.</p>
            <div class="code-block">
// After successful payment processing
if (affiliateId) {
    const commission = calculateCommission(amount);
    await creditAffiliate(affiliateId, commission, reference);
    
    // Notify affiliate
    sendAffiliateNotification(affiliateId, {
        product: productName,
        amount: amount,
        commission: commission,
        date: new Date()
    });
}
            </div>
        </div>
        
        <div class="step">
            <h4>2. Affiliate Dashboard</h4>
            <p>Create a simple dashboard where affiliates can track their performance:</p>
            <div class="code-block">
// Basic affiliate dashboard structure
// URL: yourwebsite.com/affiliate/:id
&lt;div class="affiliate-dashboard"&gt;
    &lt;h2&gt;Affiliate Performance&lt;/h2&gt;
    &lt;div class="stats"&gt;
        &lt;div&gt;Total Clicks: {{totalClicks}}&lt;/div&gt;
        &lt;div&gt;Successful Orders: {{successfulOrders}}&lt;/div&gt;
        &lt;div&gt;Total Commission: {{totalCommission}}&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="order-list"&gt;
        &lt;!-- List of successful orders --&gt;
    &lt;/div&gt;
&lt;/div&gt;
            </div>
        </div>
    </div>
    
    <div class="success">
        <i class="fas fa-lightbulb"></i> <strong>Pro Tip:</strong> Consider using a service like Zapier to connect your payment system to WhatsApp for automated notifications without coding.
    </div>
    
    <footer>
        <p>Mode Collection Payment Integration Plan | Created for your implementation team</p>
    </footer>
</body>
</html>